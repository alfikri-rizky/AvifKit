name: Publish to Maven Central

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 1.0.0)'
        required: true

jobs:
  publish:
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2
        with:
          cache-read-only: false

      - name: Validate Gradle wrapper
        uses: gradle/wrapper-validation-action@v1

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Create gradle.properties for CI
        run: |
          cat > gradle.properties << 'EOF'
          # CI/CD Build Configuration
          android.useAndroidX=true
          android.enableJetifier=false
          org.gradle.parallel=true
          org.gradle.caching=true
          org.gradle.jvmargs=-Xmx4096m -XX:MaxMetaspaceSize=1024m
          kotlin.code.style=official
          kotlin.mpp.stability.nowarn=true
          EOF

      - name: Build shared module
        run: ./gradlew :shared:build --no-daemon --stacktrace

      - name: Run tests
        run: ./gradlew :shared:test --no-daemon --stacktrace

      - name: Publish to Maven Central
        env:
          OSSRH_USERNAME: ${{ secrets.OSSRH_USERNAME }}
          OSSRH_PASSWORD: ${{ secrets.OSSRH_PASSWORD }}
          SIGNING_KEY_ID: ${{ secrets.SIGNING_KEY_ID }}
          SIGNING_PASSWORD: ${{ secrets.SIGNING_PASSWORD }}
          SIGNING_KEY: ${{ secrets.SIGNING_KEY }}
        run: |
          ./gradlew :shared:publishAllPublicationsToSonatypeRepository \
            --no-daemon \
            --stacktrace \
            -PossrhUsername="${OSSRH_USERNAME}" \
            -PossrhPassword="${OSSRH_PASSWORD}" \
            -Psigning.keyId="${SIGNING_KEY_ID}" \
            -Psigning.password="${SIGNING_PASSWORD}" \
            -Psigning.key="${SIGNING_KEY}"

      - name: Close and release repository
        if: success()
        run: |
          echo "âœ… Artifacts published to staging repository"
          echo "ðŸ“ Next steps:"
          echo "1. Go to https://s01.oss.sonatype.org"
          echo "2. Login with your OSSRH credentials"
          echo "3. Find your staging repository"
          echo "4. Click 'Close' and wait for validation"
          echo "5. Click 'Release' to publish to Maven Central"
          echo "6. Wait ~2 hours for sync"
