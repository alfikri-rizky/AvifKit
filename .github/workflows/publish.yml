name: Publish to Maven Central

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 0.1.1)'
        required: true

jobs:
  publish:
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2
        with:
          cache-read-only: false

      - name: Validate Gradle wrapper
        uses: gradle/wrapper-validation-action@v1

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Setup Android libavif
        run: |
          chmod +x scripts/setup-android-libavif.sh
          # Run setup script non-interactively (auto-answer "n" to update prompt if exists)
          echo "n" | ./scripts/setup-android-libavif.sh || true

      - name: Create gradle.properties for CI
        run: |
          cat > gradle.properties << 'EOF'
          # CI/CD Build Configuration
          android.useAndroidX=true
          android.enableJetifier=false
          org.gradle.parallel=true
          org.gradle.caching=true
          org.gradle.jvmargs=-Xmx4096m -XX:MaxMetaspaceSize=1024m
          kotlin.code.style=official
          kotlin.mpp.stability.nowarn=true

          # Library Information - CRITICAL for Maven Central namespace
          GROUP=io.github.alfikri-rizky
          VERSION_NAME=${{ github.event.inputs.version }}
          POM_ARTIFACT_ID=avifkit

          # Maven Central Publishing (New Portal API)
          mavenCentralUsername=${{ secrets.MAVEN_CENTRAL_USERNAME }}
          mavenCentralPassword=${{ secrets.MAVEN_CENTRAL_PASSWORD }}

          # GPG Signing
          signingInMemoryKey=${{ secrets.SIGNING_IN_MEMORY_KEY }}
          signingInMemoryKeyPassword=${{ secrets.SIGNING_IN_MEMORY_KEY_PASSWORD }}
          EOF

      - name: Build shared module
        run: ./gradlew :shared:build --no-daemon --stacktrace

      - name: Run tests
        run: ./gradlew :shared:test --no-daemon --stacktrace

      - name: Publish to Maven Central
        run: |
          ./gradlew :shared:publishToMavenCentral \
            --no-daemon \
            --stacktrace \
            --no-configuration-cache

      - name: Build Summary
        if: success()
        run: |
          echo "### âœ… Published to Maven Central!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Artifact:** \`io.github.alfikri-rizky:avifkit\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ **Next steps:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Go to https://central.sonatype.com/" >> $GITHUB_STEP_SUMMARY
          echo "2. Login with your credentials" >> $GITHUB_STEP_SUMMARY
          echo "3. Go to 'Deployments' section" >> $GITHUB_STEP_SUMMARY
          echo "4. Find your deployment and click 'Publish'" >> $GITHUB_STEP_SUMMARY
          echo "5. Wait ~15 minutes for Maven Central to sync" >> $GITHUB_STEP_SUMMARY
