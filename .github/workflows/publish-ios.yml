name: Publish iOS

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'  # Trigger on version tags (e.g., v0.1.1, v1.2.3)

permissions:
  contents: write  # Required to create releases and push commits

jobs:
  publish-ios:
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git operations

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2

      - name: Create gradle.properties for CI
        run: |
          cat > gradle.properties << 'EOF'
          # CI/CD Build Configuration
          android.useAndroidX=true
          android.enableJetifier=false
          org.gradle.parallel=true
          org.gradle.caching=true
          org.gradle.jvmargs=-Xmx4096m -XX:MaxMetaspaceSize=1024m
          kotlin.code.style=official
          kotlin.mpp.stability.nowarn=true
          EOF

      - name: Extract version from tag
        id: get_version
        run: |
          # Remove 'v' prefix from tag (v0.1.1 -> 0.1.1)
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Build XCFramework
        run: ./gradlew :shared:assembleSharedReleaseXCFramework --no-daemon --console=plain

      - name: Package XCFramework
        run: |
          chmod +x scripts/package-xcframework.sh
          ./scripts/package-xcframework.sh ${{ steps.get_version.outputs.VERSION }}

      - name: Calculate Checksum
        id: checksum
        run: |
          CHECKSUM=$(swift package compute-checksum build/release/Shared.xcframework.zip)
          echo "CHECKSUM=$CHECKSUM" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Checksum: $CHECKSUM"

      - name: Update Package.swift with checksum
        run: |
          VERSION="v${{ steps.get_version.outputs.VERSION }}"
          CHECKSUM="${{ steps.checksum.outputs.CHECKSUM }}"

          # Replace placeholder checksum with actual checksum
          sed -i '' "s/CHECKSUM_PLACEHOLDER_UPDATE_AFTER_BUILD/$CHECKSUM/" Package.swift

          # Update version in URL (should already be correct, but ensure it)
          sed -i '' "s|download/v[0-9]\+\.[0-9]\+\.[0-9]\+|download/$VERSION|" Package.swift

          echo "âœ… Updated Package.swift"
          echo "Checksum: $CHECKSUM"
          echo "Version: $VERSION"

      - name: Commit Package.swift changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Package.swift
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update Package.swift checksum for release ${{ steps.get_version.outputs.VERSION }} [skip ci]"
            git push origin HEAD:main || echo "âš ï¸ Failed to push, continuing..."
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: build/release/Shared.xcframework.zip
          body: |
            ## AvifKit v${{ steps.get_version.outputs.VERSION }}

            ### ðŸ“¦ Installation

            #### Kotlin Multiplatform (Recommended)
            ```kotlin
            kotlin {
                sourceSets {
                    commonMain.dependencies {
                        implementation("io.github.alfikri-rizky:avifkit:${{ steps.get_version.outputs.VERSION }}")
                    }
                }
            }
            ```

            #### Android Only
            ```kotlin
            dependencies {
                implementation("io.github.alfikri-rizky:avifkit:${{ steps.get_version.outputs.VERSION }}")
            }
            ```

            #### iOS - Swift Package Manager
            ```swift
            dependencies: [
                .package(url: "https://github.com/alfikri-rizky/AvifKit.git", from: "${{ steps.get_version.outputs.VERSION }}")
            ]
            ```

            #### iOS - CocoaPods
            ```ruby
            pod 'AvifKit', '~> ${{ steps.get_version.outputs.VERSION }}'
            ```

            ### âœ¨ Features
            - ðŸ–¼ï¸ AVIF encoding/decoding for iOS and Android
            - ðŸŽ¯ Adaptive compression strategies (SMART/STRICT)
            - âš¡ Quality presets (SPEED/BALANCED/QUALITY/STORAGE)
            - ðŸ“± Native performance using libavif
            - ðŸ”„ Kotlin Multiplatform shared code
            - ðŸ“‚ PlatformFile API for cross-platform file operations
            - âœ… Android: libavif bundled in AAR automatically
            - âœ… iOS: libavif resolved via SPM/CocoaPods automatically

            ### ðŸ” XCFramework Checksum
            ```
            ${{ steps.checksum.outputs.CHECKSUM }}
            ```

            ### ðŸ“š Links
            - [README](https://github.com/alfikri-rizky/AvifKit/blob/main/README.md)
            - [Shared Module README](https://github.com/alfikri-rizky/AvifKit/blob/main/shared/README.md)
            - [Maven Central](https://central.sonatype.com/artifact/io.github.alfikri-rizky/avifkit/${{ steps.get_version.outputs.VERSION }})
            - [Publishing Guide](https://github.com/alfikri-rizky/AvifKit/blob/main/PUBLISH_V0.1.1.md)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish to CocoaPods (Optional)
        if: ${{ vars.ENABLE_COCOAPODS_PUBLISH == 'true' }}
        env:
          COCOAPODS_TRUNK_TOKEN: ${{ secrets.COCOAPODS_TRUNK_TOKEN }}
        run: |
          echo "ðŸ“¦ Publishing to CocoaPods..."
          pod trunk push AvifKit.podspec --allow-warnings

      - name: Build Summary
        run: |
          echo "### ðŸŽ‰ iOS Release Published Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.get_version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "**XCFramework Size:** $(du -h build/release/Shared.xcframework.zip | cut -f1)" >> $GITHUB_STEP_SUMMARY
          echo "**Checksum:** \`${{ steps.checksum.outputs.CHECKSUM }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Distribution" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… GitHub Release created" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… XCFramework uploaded" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Package.swift updated with checksum" >> $GITHUB_STEP_SUMMARY
          if [ "${{ vars.ENABLE_COCOAPODS_PUBLISH }}" == "true" ]; then
            echo "- âœ… CocoaPods published" >> $GITHUB_STEP_SUMMARY
          else
            echo "- â­ï¸ CocoaPods publishing skipped (set ENABLE_COCOAPODS_PUBLISH variable to enable)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Verify GitHub release at: https://github.com/alfikri-rizky/AvifKit/releases/tag/v${{ steps.get_version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "2. Test SPM installation in an iOS project" >> $GITHUB_STEP_SUMMARY
          echo "3. Publish to Maven Central if not done yet" >> $GITHUB_STEP_SUMMARY
